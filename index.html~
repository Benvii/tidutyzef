<!DOCTYPE html>
<html>
<head>
	<title>WebSocket test</title>
    <meta charset="UTF-8"/>
	<script src="./wsLib.js"></script>
    <script>
    var webSocket = false;
    var ws = new wsLib();
    var username;
    
    function qs(s){
        return document.querySelector(s);
    }
    
    function setStatut (s){
        qs("#status").innerHTML=s;
    }
    
    function addMessage(from, msg){
        qs("#msg").innerHTML=qs("#msg").innerHTML+"<br>"+from+" say : "+msg;
    }
    
    function onMessage (e){   
        rep = JSON.parse(e.data);
        console.log( rep );
        switch (rep.object){
            case "error":
                onError(rep);
                break;
            case "msg":
                if( rep.hasOwnProperty ("msg") && rep.hasOwnProperty("from")){
                    addMessage(rep.from, rep.msg);
                }
                break;
            case "login":
                setStatut("Connecté");
                username = rep.user;
                break;
            case "logout":
                setStatut("Déconnecté");
                break;
        }

    }
    
    function onError (e){
        switch(e.errorCode){
            case 0:
                alert("Pb de pseudo");
                break;
            default:
                if (e.desc != ""){
                    alert(e.desc);
                }
                else{
                    alert("Erreur indéfinie");
                }
        }
    }
    
    function onClose(){
        var data = {object :"logout"};
        sendToServ(data);
        webSocket = false;
        setStatut("Déconnecté");
    }
    
    function openConnection (){
        if(!webSocket){
            ws.openSocket(qs('#ws_url').value,
                connectionOpened,
                onClose,
                onMessage,
                onError );
        }
    }
    
    function connectionOpened (){
        webSocket = true;
        setStatut('Veuillez entrer votre pseudo');
    }
    
    function sendToServ (data){
        if(webSocket && ! ws.isClosed()){
            ws.msg(data);
        } 
        else{
            ws.close();
        }
    
    }
    
    function login (){
        var data = {object: "login",
                        username: qs('#pseudo').value}
        sendToServ(data);
    }

    function sendMsg (){
        var data = {object: "msg",
                        msg: qs('#sendMsg').value};
        sendToServ(data);
    }   
    function setPos(){
        var data = {object: "updatePos",
                        lat: qs('#lat').value,
                        lng: qs('#lng').value};
        sendToServ(data);

    }
</script>
</head>
<body>

<label>URL du ws : <input type="text" id="ws_url" value="ws://localhost:9876/"></label>
<button onclick="openConnection()">Open connexion</button><br>
<label>Pseudo : <input type="text" id="pseudo"></label>
<button onclick="login()">Définir le pseudo</button>

<br><br>
<label>Message : <input type="text" id="sendMsg"></label>
<button onclick="sendMsg()">Message</button>

<br><br>
<label>Latitude : <input type="text" id="lat"></label>
<label>Longitude : <input type="text" id="lng"></label>
<button onclick="setPos()">Changer de position</button>

<br><br>
<span id="status"></span>

<br><br>
<span id="msg"></span>

</body>
</html>
